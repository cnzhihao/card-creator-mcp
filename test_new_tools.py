#!/usr/bin/env python3
"""
æµ‹è¯•æ–°çš„DocGeniuså·¥å…·åŠŸèƒ½
"""
import asyncio
import os
from pathlib import Path

# æµ‹è¯•ç”¨çš„HTMLå†…å®¹
TEST_HTML = """<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•æ–‡æ¡£</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .content {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        .footer {
            text-align: center;
            margin-top: 30px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¨ DocGenius æµ‹è¯•æ–‡æ¡£</h1>
        <p>è¿™æ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯•æ–°å·¥å…·åŠŸèƒ½çš„HTMLæ–‡æ¡£</p>
    </div>
    
    <div class="content">
        <h2>âœ¨ åŠŸèƒ½ç‰¹è‰²</h2>
        <ul>
            <li>ğŸ“ HTMLæ–‡ä»¶ä¿å­˜åŠŸèƒ½</li>
            <li>ğŸ–¼ï¸ å›¾ç‰‡ç”ŸæˆåŠŸèƒ½</li>
            <li>ğŸ“ åŸºäºæ¨¡æ¿çš„æ–‡ä»¶ç»„ç»‡</li>
            <li>ğŸŒ å¤šè¯­è¨€æ”¯æŒ</li>
        </ul>
        
        <h2>ğŸ”§ æŠ€æœ¯æ ˆ</h2>
        <p>æœ¬é¡¹ç›®ä½¿ç”¨ä»¥ä¸‹æŠ€æœ¯ï¼š</p>
        <ul>
            <li>Python + FastMCP</li>
            <li>Playwright è‡ªåŠ¨åŒ–</li>
            <li>aiofiles å¼‚æ­¥æ–‡ä»¶æ“ä½œ</li>
            <li>HTML + CSS å“åº”å¼è®¾è®¡</li>
        </ul>
    </div>
    
    <div class="footer">
        <p>Generated by DocGenius Â© 2025</p>
    </div>
</body>
</html>"""

async def test_tools():
    """æµ‹è¯•æ–°å·¥å…·åŠŸèƒ½"""
    print("ğŸ§ª å¼€å§‹æµ‹è¯• DocGenius æ–°å·¥å…·åŠŸèƒ½...")
    
    # æµ‹è¯•å‚æ•°
    template_name = "test"
    file_name = "test_document"
    width = 1200
    height = 800
    
    print(f"\nğŸ“‹ æµ‹è¯•å‚æ•°:")
    print(f"  æ¨¡æ¿åç§°: {template_name}")
    print(f"  æ–‡ä»¶åç§°: {file_name}")
    print(f"  å›¾ç‰‡å°ºå¯¸: {width}x{height}")
    print(f"  å½“å‰å·¥ä½œç›®å½•: {Path.cwd()}")
    
    # å¯¼å…¥å·¥å…·å‡½æ•°
    try:
        from main_service import _save_html_file, _create_image_from_html_file
        print("\nâœ… æˆåŠŸå¯¼å…¥å·¥å…·å‡½æ•°")
    except ImportError as e:
        print(f"\nâŒ å¯¼å…¥å·¥å…·å‡½æ•°å¤±è´¥: {e}")
        return
    
    # æµ‹è¯•1: ä¿å­˜HTMLæ–‡ä»¶
    print("\nğŸ“ æµ‹è¯•1: ä¿å­˜HTMLæ–‡ä»¶...")
    try:
        html_path = await _save_html_file(TEST_HTML, template_name, file_name)
        print(f"âœ… HTMLæ–‡ä»¶ä¿å­˜æˆåŠŸ: {html_path}")
        
        # éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if Path(html_path).exists():
            file_size = Path(html_path).stat().st_size
            print(f"âœ… æ–‡ä»¶éªŒè¯é€šè¿‡ï¼Œå¤§å°: {file_size} bytes")
        else:
            print("âŒ æ–‡ä»¶éªŒè¯å¤±è´¥ï¼Œæ–‡ä»¶ä¸å­˜åœ¨")
            return
            
    except Exception as e:
        print(f"âŒ HTMLæ–‡ä»¶ä¿å­˜å¤±è´¥: {e}")
        return
    
    # æµ‹è¯•2: ç”Ÿæˆå›¾ç‰‡
    print("\nğŸ–¼ï¸ æµ‹è¯•2: ç”Ÿæˆå›¾ç‰‡...")
    try:
        jpg_path = await _create_image_from_html_file(html_path, width, height)
        print(f"âœ… å›¾ç‰‡ç”ŸæˆæˆåŠŸ: {jpg_path}")
        
        # éªŒè¯å›¾ç‰‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if Path(jpg_path).exists():
            file_size = Path(jpg_path).stat().st_size
            print(f"âœ… å›¾ç‰‡éªŒè¯é€šè¿‡ï¼Œå¤§å°: {file_size} bytes")
        else:
            print("âŒ å›¾ç‰‡éªŒè¯å¤±è´¥ï¼Œæ–‡ä»¶ä¸å­˜åœ¨")
            return
            
    except Exception as e:
        print(f"âŒ å›¾ç‰‡ç”Ÿæˆå¤±è´¥: {e}")
        return
    
    # æµ‹è¯•3: ç¯å¢ƒå˜é‡æµ‹è¯•
    print("\nğŸŒ æµ‹è¯•3: ç¯å¢ƒå˜é‡æ”¯æŒ...")
    original_env = os.getenv('DOCGENIUS_TEMPLATES_DIR')
    
    # è®¾ç½®æµ‹è¯•ç¯å¢ƒå˜é‡
    test_templates_dir = Path.cwd() / "test_templates"
    os.environ['DOCGENIUS_TEMPLATES_DIR'] = str(test_templates_dir)
    
    # é‡æ–°å¯¼å…¥ä»¥æµ‹è¯•ç¯å¢ƒå˜é‡
    try:
        import importlib
        import main_service
        importlib.reload(main_service)
        
        print(f"âœ… ç¯å¢ƒå˜é‡è®¾ç½®æˆåŠŸ: {test_templates_dir}")
        print(f"âœ… æ–°çš„æ¨¡æ¿ç›®å½•: {main_service.TEMPLATE_DIR}")
        
    except Exception as e:
        print(f"âŒ ç¯å¢ƒå˜é‡æµ‹è¯•å¤±è´¥: {e}")
    finally:
        # æ¢å¤åŸå§‹ç¯å¢ƒå˜é‡
        if original_env:
            os.environ['DOCGENIUS_TEMPLATES_DIR'] = original_env
        else:
            os.environ.pop('DOCGENIUS_TEMPLATES_DIR', None)
    
    # æµ‹è¯•å®Œæˆ
    print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆ!")
    print(f"\nğŸ“ ç”Ÿæˆçš„æ–‡ä»¶:")
    print(f"  HTML: {html_path}")
    print(f"  JPG:  {jpg_path}")
    
    print(f"\nğŸ“‚ è¾“å‡ºç›®å½•ç»“æ„:")
    output_dir = Path.cwd() / "pic" / template_name
    if output_dir.exists():
        for file in output_dir.iterdir():
            print(f"  {file.name} ({file.stat().st_size} bytes)")

if __name__ == "__main__":
    asyncio.run(test_tools()) 